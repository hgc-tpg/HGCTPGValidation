pipeline {
    agent {
        label 'llrgrhgtrig.in2p3.fr'
    }
    environment {
        EMAIL_TO = 'emilia.becheva@llr.in2p3.fr'
    }
    options {
        skipDefaultCheckout() 
    }
    stages {
        stage('InstallAutoValidationPackage') {
            steps {
                echo 'Building..'
                sh '''
                uname -a
                whoami
                pwd
                ls -l
                if [ -d "./HGCTPGValidation" ] 
                then
                    rm -rf HGCTPGValidation
                fi
                git clone -b master https://github.com/ebecheva/HGCTPGValidation HGCTPGValidation
                ~/grid_login
                source HGCTPGValidation/env_install.sh
                pip install attrs
                if [ -d "./test_dir" ] 
                then
                    echo "Directory test_dir exists." 
                    rm -rf test_dir
                fi
                mkdir test_dir

                ls -lrt ..
                '''
            }
        }
        stage('BuildValidation'){
            failFast true
            parallel{
                stage(BuildCMSSWRef){
                    stages{
                        stage('Install'){
                            steps {
                                echo 'InstallCMSSW Ref step..'
                                sh '''
                                pwd
                                ~/grid_login
                                cd test_dir
                                ../HGCTPGValidation/scripts/installCMSSWRef.sh
                                '''
                            }
                        }
                        stage('Produce'){
                            steps {
                                sh '''
                                pwd
                                ~/grid_login
                                cd test_dir/CMSSW_12_1_0_pre3_HGCalTPGValidation_ref/src
                                ../../../HGCTPGValidation/scripts/produceDataRef.sh
                                '''            
                            }
                        }
                    }
                }
                stage(BuildCMSSWTest){
                    stages{
                        stage('Install'){
                            steps {
                                echo 'InstallCMSSW Test step..'
                                sh '''
                                pwd
                                ~/grid_login
                                cd test_dir
                                ../HGCTPGValidation/scripts/installCMSSWTest.sh
                                '''
                            }
                        }
                        stage('Produce'){
                            steps {
                                sh '''
                                pwd
                                ~/grid_login
                                cd test_dir/CMSSW_12_1_0_pre3_HGCalTPGValidation_test/src
                                ../../../HGCTPGValidation/scripts/produceDataTest.sh
                                '''            
                            }
                        }
                    }
                }
            }
        }
        stage('Display') {
            steps {
                sh '''
                cd test_dir
                source ../HGCTPGValidation/env_install.sh
                echo $PWD
                ../HGCTPGValidation/scripts/displayHistos.sh ./CMSSW_12_1_0_pre3_HGCalTPGValidation_ref/src ./CMSSW_12_1_0_pre3_HGCalTPGValidation_test/src ./GIFS
                echo 'CHANGE_ID= ', $CHANGE_ID
                echo '$CHANGE_TITLE= ', $CHANGE_TITLE
                if [ -d /data/jenkins/workspace/validation_data/PR$CHANGE_ID ] 
                then
                    echo "Directory " PR$CHANGE_ID " exists." 
                    rm -rf /data/jenkins/workspace/validation_data/PR$CHANGE_ID
                fi
                export data_dir=/data/jenkins/workspace/validation_data
                mkdir $data_dir/PR$CHANGE_ID
                cp -rf GIFS/. $data_dir/PR$CHANGE_ID
                python ../HGCTPGValidation/scripts/writeToFile.py --dirname $data_dir/PR$CHANGE_ID --prnumber $CHANGE_ID --prtitle "PR$CHANGE_ID : $CHANGE_TITLE"
                '''            
            }
        }
    }
    post {
        always {
            echo 'One way or another, I have finished'
            mail to: '${EMAIL_TO}',
            subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
            body: "The job finished successfully."
        }
        success {
            echo 'I succeeded!'
        }
        unstable {
            echo 'I am unstable :/'
        }
        failure {
            echo ‘Job failed’
            mail to: '${EMAIL_TO}',
            subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
            body: "Something is wrong with ${env.BUILD_URL}, $PROJECT_NAME - #$BUILD_NUMBER, Check console output at $BUILD_URL to view the results. \n\n ${CHANGES}"
        }
        changed {
            echo 'Things were different before...'
        }
    }
}
